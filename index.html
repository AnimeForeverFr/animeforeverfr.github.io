<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anime Forever</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&display=swap');
    :root { --bg:#0d0d0d; --card:#1a1a1a; --accent:#ff3d00; --muted:#ccc; --success:#4caf50; --error:#f44336; }
    body{margin:0;font-family:'Nunito Sans',sans-serif;background:var(--bg);color:#f0f0f0}
    header{background:var(--card);padding:1rem;display:flex;justify-content:space-between;align-items:center}
    header h1{color:var(--accent);margin:0}
    nav button{background:var(--accent);border:none;color:#fff;padding:.5rem 1rem;border-radius:6px;cursor:pointer;margin-left:0.5rem;}
    nav button:hover{opacity:0.9;}
    main{padding:1rem}
    .series-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
    .card{background:var(--card);padding:1rem;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.5)}
    img.series-img{width:100%;height:140px;object-fit:cover;border-radius:6px}
    .episode{background:#222;padding:.5rem;border-radius:6px;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
    input,select,textarea{width:100%;padding:.5rem;border-radius:6px;border:none;margin:.4rem 0;box-sizing:border-box;background:#333;color:white;}
    .btn{background:#00bfa5;color:#fff;border:none;padding:.6rem 1rem;border-radius:6px;cursor:pointer;transition:opacity 0.2s;}
    .btn:hover{opacity:0.9;}
    .btn:disabled{opacity:0.6;cursor:not-allowed;}
    .danger{background:#e53935}
    .success{background:var(--success)}
    .muted{color:var(--muted)}
    .error{color:var(--error)}
    .success{color:var(--success)}
    .hidden{display:none}
    .top-right{position:fixed;right:1rem;top:1rem;z-index:2000;display:flex;align-items:center;gap:0.5rem;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%, -50%);width:90%;max-width:400px;background:#1a1a1a;padding:2rem;border-radius:8px;z-index:9999;box-shadow:0 0 20px rgba(0,0,0,0.7);}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9998;}
    .auth-tabs{display:flex;margin-bottom:1rem;border-bottom:1px solid #333;}
    .auth-tab{padding:0.5rem 1rem;cursor:pointer;border-bottom:2px solid transparent;}
    .auth-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
    .auth-form{display:block;}
    .auth-form.hidden{display:none;}
    .loading{opacity:0.6;pointer-events:none;}
    .episode-block{background:#222;padding:.8rem;border-radius:6px;margin-bottom:.5rem;}
    .episode-block input{margin:.3rem 0;}
    video{width:100%;max-height:400px;border-radius:6px;background:#000;}
  </style>
</head>
<body>
  <!-- auth modal -->
  <div id="authModal" class="modal hidden">
    <div class="auth-tabs">
      <div class="auth-tab active" id="loginTab">Connexion</div>
      <div class="auth-tab" id="registerTab">Inscription</div>
    </div>

    <div id="loginForm" class="auth-form">
      <input id="authUsername" placeholder="Pseudo" />
      <input id="authPassword" placeholder="Mot de passe" type="password" />
      <div style="display:flex;gap:.5rem;margin-top:1rem;">
        <button id="loginBtn" class="btn" style="flex:1;">Se connecter</button>
      </div>
      <p id="authMsg" class="muted" style="margin-top:1rem;"></p>
      <p class="muted" style="margin-top:1rem;font-size:0.9rem;">üí° Compte admin : <strong>admin</strong> / <strong>admin</strong></p>
    </div>

    <div id="registerForm" class="auth-form hidden">
      <input id="regUsername" placeholder="Pseudo (min. 3 caract√®res)" />
      <input id="regPassword" placeholder="Mot de passe (min. 6 caract√®res)" type="password" />
      <input id="regPassword2" placeholder="R√©p√©ter mot de passe" type="password" />
      <div style="display:flex;gap:.5rem;margin-top:1rem;">
        <button id="regBtn" class="btn success" style="flex:1;">S'inscrire</button>
      </div>
      <p id="regMsg" class="muted" style="margin-top:1rem;"></p>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay hidden"></div>

  <div class="top-right">
    <span id="userInfo" class="muted"></span>
    <button id="logoutBtn" class="btn danger" style="display:none">D√©connexion</button>
    <button id="authBtn" class="btn">Connexion</button>
  </div>

  <header>
    <h1>Anime Forever</h1>
    <nav>
      <button onclick="showSection('home')">Accueil</button>
      <button onclick="showSection('create')">Cr√©er s√©rie / √©pisodes</button>
    </nav>
  </header>

  <main>
    <section id="home">
      <h2>Nos s√©ries</h2>
      <div id="seriesGrid" class="series-grid"></div>
    </section>

    <section id="create" style="display:none">
      <h2>Cr√©er une s√©rie</h2>
      <div class="card">
        <label>Pseudo</label>
        <input id="createPseudo" placeholder="Ton pseudo" />
        <label>Nom de la s√©rie</label>
        <input id="createName" placeholder="Titre de la s√©rie" />
        <label>Description</label>
        <textarea id="createDesc"></textarea>
        <label>Image (URL)</label>
        <input id="createImg" placeholder="https://..." />
        <hr />
        <h3>√âpisodes</h3>
        <div id="epBlocks"></div>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn" onclick="addEpBlock()">+ Ajouter √©pisode</button>
          <button class="btn" onclick="clearEpBlocks()">R√©initialiser</button>
        </div>
        <p class="muted">Choisissez un fichier local OU entrez une URL de vid√©o.</p>
        <div style="margin-top:.6rem">
          <button class="btn" onclick="submitCreate()">Cr√©er la s√©rie</button>
        </div>
      </div>
    </section>
  </main>

  <!-- simple modal for series details -->
  <div id="seriesModal" class="modal hidden"></div>

<script>
const API_ROOT = '';
let token = localStorage.getItem('token') || null;
let currentUser = null;

async function apiFetch(url, opts = {}) {
  opts.headers = opts.headers || {};
  if (token && !url.includes('/login') && !url.includes('/register')) {
    opts.headers['Authorization'] = 'Bearer ' + token;
  }
  
  if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(opts.body);
  }

  const response = await fetch(API_ROOT + url, opts);
  const text = await response.text();
  let data;
  try {
    data = text ? JSON.parse(text) : {};
  } catch (e) {
    throw new Error('R√©ponse serveur invalide');
  }
  
  return {
    ok: response.ok,
    status: response.status,
    json: () => Promise.resolve(data)
  };
}

async function loadMe() {
  if (!token) return;
  try {
    const res = await apiFetch('/api/me');
    const json = await res.json();
    
    if (res.ok && json.username) {
      currentUser = json;
      updateUIAfterAuth();
    } else {
      await handleLogout();
    }
  } catch (e) { 
    console.error('Erreur loadMe:', e);
    await handleLogout();
  }
}

function updateUIAfterAuth() {
  if (currentUser) {
    document.getElementById('userInfo').innerText = currentUser.username + (currentUser.isAdmin ? ' (admin)' : '');
    document.getElementById('logoutBtn').style.display = '';
    document.getElementById('authBtn').style.display = 'none';
    hideAuthModal();
  } else {
    document.getElementById('userInfo').innerText = '';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('authBtn').style.display = '';
  }
}

async function handleLogout() {
  token = null; 
  localStorage.removeItem('token'); 
  currentUser = null;
  updateUIAfterAuth();
  showAuthModal();
}

function showAuthModal() {
  document.getElementById('authModal').classList.remove('hidden');
  document.getElementById('modalOverlay').classList.remove('hidden');
  switchToLogin();
}

function hideAuthModal() {
  document.getElementById('authModal').classList.add('hidden');
  document.getElementById('modalOverlay').classList.add('hidden');
}

function switchToLogin() {
  document.getElementById('loginTab').classList.add('active');
  document.getElementById('registerTab').classList.remove('active');
  document.getElementById('loginForm').classList.remove('hidden');
  document.getElementById('registerForm').classList.add('hidden');
  clearAuthMessages();
}

function switchToRegister() {
  document.getElementById('registerTab').classList.add('active');
  document.getElementById('loginTab').classList.remove('active');
  document.getElementById('registerForm').classList.remove('hidden');
  document.getElementById('loginForm').classList.add('hidden');
  clearAuthMessages();
}

function clearAuthMessages() {
  document.getElementById('authMsg').innerText = '';
  document.getElementById('authMsg').className = 'muted';
  document.getElementById('regMsg').innerText = '';
  document.getElementById('regMsg').className = 'muted';
}

function showAuthMessage(elementId, message, isError = true) {
  const element = document.getElementById(elementId);
  element.innerText = message;
  element.className = isError ? 'error' : 'success';
}

function setLoading(button, isLoading, originalText) {
  if (isLoading) {
    button.classList.add('loading');
    button.disabled = true;
    button.dataset.originalText = button.innerHTML;
    button.innerHTML = 'Chargement...';
  } else {
    button.classList.remove('loading');
    button.disabled = false;
    button.innerHTML = button.dataset.originalText || originalText;
  }
}

document.getElementById('loginBtn').addEventListener('click', async () => {
  const username = document.getElementById('authUsername').value.trim();
  const password = document.getElementById('authPassword').value;

  if (!username || !password) {
    return showAuthMessage('authMsg', 'Veuillez remplir tous les champs');
  }

  setLoading(document.getElementById('loginBtn'), true);

  try {
    const res = await apiFetch('/api/login', { 
      method: 'POST',
      body: { username, password }
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || 'Erreur de connexion');
    }

    token = data.token;
    localStorage.setItem('token', token);
    currentUser = data.user;
    
    showAuthMessage('authMsg', 'Connexion r√©ussie !', false);
    setTimeout(() => {
      updateUIAfterAuth();
      renderSeries();
    }, 1000);

  } catch (error) {
    showAuthMessage('authMsg', error.message);
  } finally {
    setLoading(document.getElementById('loginBtn'), false, 'Se connecter');
  }
});

document.getElementById('regBtn').addEventListener('click', async () => {
  const username = document.getElementById('regUsername').value.trim();
  const password = document.getElementById('regPassword').value;
  const password2 = document.getElementById('regPassword2').value;

  if (!username || !password || !password2) {
    return showAuthMessage('regMsg', 'Veuillez remplir tous les champs');
  }

  if (password !== password2) {
    return showAuthMessage('regMsg', 'Les mots de passe ne correspondent pas');
  }

  setLoading(document.getElementById('regBtn'), true);

  try {
    const res = await apiFetch('/api/register', { 
      method: 'POST',
      body: { username, password }
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || 'Erreur d\'inscription');
    }

    token = data.token;
    localStorage.setItem('token', token);
    currentUser = data.user;
    
    showAuthMessage('regMsg', 'Inscription r√©ussie !', false);
    setTimeout(() => {
      updateUIAfterAuth();
      renderSeries();
    }, 1000);

  } catch (error) {
    showAuthMessage('regMsg', error.message);
  } finally {
    setLoading(document.getElementById('regBtn'), false, 'S\'inscrire');
  }
});

document.getElementById('loginTab').addEventListener('click', switchToLogin);
document.getElementById('registerTab').addEventListener('click', switchToRegister);
document.getElementById('authBtn').addEventListener('click', showAuthModal);
document.getElementById('logoutBtn').addEventListener('click', handleLogout);
document.getElementById('modalOverlay').addEventListener('click', hideAuthModal);

async function showSection(id) {
  document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = '';
  if (id === 'home') await renderSeries();
  if (id === 'create') {
    document.getElementById('createPseudo').value = currentUser ? currentUser.username : '';
  }
}

async function renderSeries() {
  const grid = document.getElementById('seriesGrid');
  grid.innerHTML = '<p class="muted">Chargement...</p>';
  try {
    const res = await apiFetch('/api/series');
    const data = await res.json();
    
    grid.innerHTML = '';
    if (!data || !data.length) {
      grid.innerHTML = '<p class="muted">Aucune s√©rie pour le moment.</p>';
      return;
    }
    
    data.forEach(s => {
      const el = document.createElement('div'); 
      el.className = 'card';
      el.innerHTML = `
        <img class="series-img" src="${s.image || 'https://via.placeholder.com/300x140/1a1a1a/666666?text=No+Image'}" alt="${s.name}" onerror="this.src='https://via.placeholder.com/300x140/1a1a1a/666666?text=Image+Error'">
        <h3>${s.name}</h3>
        <p class="muted">${s.desc || ''}</p>
        <p class="muted">Ajout√© par : ${s.pseudo}</p>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn" onclick='openSeries("${s.id}")'>Voir</button>
          ${ (currentUser && currentUser.isAdmin) ? `<button class="btn danger" onclick='deleteSeries("${s.id}")'>Supprimer</button>` : ''}
        </div>
      `;
      grid.appendChild(el);
    });
  } catch (error) {
    console.error('Erreur renderSeries:', error);
    grid.innerHTML = '<p class="error">Erreur de chargement des s√©ries.</p>';
  }
}

async function openSeries(id) {
  try {
    const res = await apiFetch('/api/series/' + id);
    const s = await res.json();
    
    const modal = document.getElementById('seriesModal');
    modal.innerHTML = `
      <h2>${s.name}</h2>
      <p class="muted">${s.desc || ''}</p>
      <hr style="border-color:#333;margin:1rem 0">
      <h3>√âpisodes (${s.episodes.length})</h3>
      ${s.episodes.map(ep => `
        <div class="episode">
          <div>
            <strong>${ep.title}</strong>
            <p class="muted" style="margin:0;font-size:0.85rem">Par ${ep.pseudo}</p>
          </div>
          <button class="btn" onclick='playEpisode(${JSON.stringify(ep)})'>‚ñ∂ Lire</button>
        </div>
      `).join('')}
      <button class="btn danger" onclick="closeSeriesModal()" style="margin-top:1rem;width:100%">Fermer</button>
    `;
    modal.classList.remove('hidden');
    document.getElementById('modalOverlay').classList.remove('hidden');
  } catch (error) {
    alert('Erreur lors du chargement de la s√©rie');
  }
}

function closeSeriesModal() {
  document.getElementById('seriesModal').classList.add('hidden');
  document.getElementById('modalOverlay').classList.add('hidden');
}

function playEpisode(ep) {
  const modal = document.getElementById('seriesModal');
  modal.innerHTML = `
    <h3>${ep.title}</h3>
    <video controls autoplay>
      <source src="${ep.src}" type="video/mp4">
      Votre navigateur ne supporte pas la lecture vid√©o.
    </video>
    <button class="btn" onclick="closeSeriesModal()" style="margin-top:1rem;width:100%">Fermer</button>
  `;
}

async function deleteSeries(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette s√©rie ?')) return;
  
  try {
    const res = await apiFetch('/api/series/' + id, { method: 'DELETE' });
    if (res.ok) {
      alert('S√©rie supprim√©e');
      renderSeries();
    } else {
      const data = await res.json();
      alert(data.error || 'Erreur');
    }
  } catch (error) {
    alert('Erreur lors de la suppression');
  }
}

function addEpBlock() {
  const list = document.getElementById('epBlocks');
  const div = document.createElement('div');
  div.className = 'episode-block';
  div.innerHTML = `
    <input class="epTitle" placeholder="Titre √©pisode (optionnel)" style="margin-bottom:0.3rem"/>
    <input class="epUrl" placeholder="URL vid√©o (si pas de fichier)" style="margin-bottom:0.3rem"/>
    <input type="file" class="epFile" accept="video/*"/>
  `;
  list.appendChild(div);
}

function clearEpBlocks() {
  document.getElementById('epBlocks').innerHTML = '';
}

function clearForm() {
  document.getElementById('createPseudo').value = '';
  document.getElementById('createName').value = '';
  document.getElementById('createDesc').value = '';
  document.getElementById('createImg').value = '';
  clearEpBlocks();
  addEpBlock();
}

async function submitCreate() {
  const pseudo = document.getElementById('createPseudo').value.trim();
  const name = document.getElementById('createName').value.trim();
  const desc = document.getElementById('createDesc').value.trim();
  const image = document.getElementById('createImg').value.trim();

  if (!pseudo || !name) {
    return alert('Le pseudo et le nom de la s√©rie sont requis');
  }

  const blocks = document.querySelectorAll('.episode-block');
  if (blocks.length === 0) {
    return alert('Ajoutez au moins un √©pisode');
  }

  const formData = new FormData();
  formData.append('pseudo', pseudo);
  formData.append('name', name);
  formData.append('desc', desc);
  formData.append('image', image);

  let episodesData = [];
  
  for (let i = 0; i < blocks.length; i++) {
    const block = blocks[i];
    const title = block.querySelector('.epTitle').value.trim() || `√âpisode ${i + 1}`;
    const url = block.querySelector('.epUrl').value.trim();
    const fileInput = block.querySelector('.epFile');
    const file = fileInput.files[0];

    if (!url && !file) {
      return alert(`√âpisode ${i + 1}: Fournissez soit un lien, soit un fichier`);
    }

    if (file) {
      formData.append(`episode_${i}`, file);
      episodesData.push({ title, hasFile: true, index: i });
    } else {
      episodesData.push({ title, src: url, hasFile: false });
    }
  }

  formData.append('episodes', JSON.stringify(episodesData));

  try {
    const res = await fetch(API_ROOT + '/api/series', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : {},
      body: formData
    });

    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || 'Erreur lors de la cr√©ation');
    }

    alert('S√©rie cr√©√©e avec succ√®s !');
    clearForm();
    showSection('home');
  } catch (error) {
    alert('Erreur: ' + error.message);
    console.error(error);
  }
}

(async () => {
  if (token) {
    await loadMe();
  }
  addEpBlock();
  await renderSeries();
})();
</script>
</body>
  </html>
