<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anime Forever</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700&display=swap');
    :root { --bg:#0d0d0d; --card:#1a1a1a; --accent:#ff3d00; --muted:#ccc; }
    body{margin:0;font-family:'Nunito Sans',sans-serif;background:var(--bg);color:#f0f0f0}
    header{background:var(--card);padding:1rem;display:flex;justify-content:space-between;align-items:center}
    header h1{color:var(--accent);margin:0}
    nav button{background:var(--accent);border:none;color:#fff;padding:.5rem 1rem;border-radius:6px;cursor:pointer}
    main{padding:1rem}
    .series-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
    .card{background:var(--card);padding:1rem;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.5)}
    img.series-img{width:100%;height:140px;object-fit:cover;border-radius:6px}
    .episode{background:#222;padding:.5rem;border-radius:6px;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
    input,select,textarea{width:100%;padding:.5rem;border-radius:6px;border:none;margin:.4rem 0}
    .btn{background:#00bfa5;color:#fff;border:none;padding:.6rem 1rem;border-radius:6px;cursor:pointer}
    .danger{background:#e53935}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .top-right{position:fixed;right:1rem;top:1rem;z-index:2000}
    .modal{position:fixed;left:5%;top:5%;right:5%;bottom:5%;background:#0b0b0b;padding:1rem;overflow:auto;border-radius:8px;z-index:9999}
  </style>
</head>
<body>
  <!-- auth modal -->
  <div id="authModal" class="modal" style="display:none">
    <h2 id="authTitle">Connexion</h2>
    <div id="authForm">
      <input id="authUsername" placeholder="Pseudo" />
      <input id="authPassword" placeholder="Mot de passe" type="password" />
      <div style="display:flex;gap:.5rem">
        <button id="loginBtn" class="btn">Se connecter</button>
        <button id="showRegister" class="btn" style="background:#2979ff">S'inscrire</button>
      </div>
      <p id="authMsg" class="muted"></p>
    </div>
    <div id="registerForm" style="display:none">
      <input id="regUsername" placeholder="Pseudo" />
      <input id="regPassword" placeholder="Mot de passe" type="password" />
      <input id="regPassword2" placeholder="Répéter mot de passe" type="password" />
      <div style="display:flex;gap:.5rem">
        <button id="regBtn" class="btn">S'inscrire</button>
        <button id="showLogin" class="btn" style="background:#ff7043">Se connecter</button>
      </div>
      <p id="regMsg" class="muted"></p>
    </div>
  </div>

  <div class="top-right">
    <span id="userInfo" class="muted"></span>
    <button id="logoutBtn" class="btn" style="display:none">Déconnexion</button>
  </div>

  <header>
    <h1>Anime Forever</h1>
    <nav>
      <button onclick="showSection('home')">Accueil</button>
      <button onclick="showSection('create')">Créer série / épisodes</button>
    </nav>
  </header>

  <main>
    <section id="home">
      <h2>Nos séries</h2>
      <div id="seriesGrid" class="series-grid"></div>
    </section>

    <section id="create" style="display:none">
      <h2>Créer une série</h2>
      <div class="card">
        <label>Pseudo</label>
        <input id="createPseudo" placeholder="Ton pseudo" />
        <label>Nom de la série</label>
        <input id="createName" placeholder="Titre de la série" />
        <label>Description</label>
        <textarea id="createDesc"></textarea>
        <label>Image (URL)</label>
        <input id="createImg" placeholder="https://..." />
        <hr />
        <h3>Épisodes</h3>
        <div id="epBlocks"></div>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn" onclick="addEpBlock()">+ Ajouter épisode</button>
          <button class="btn" onclick="clearEpBlocks()">Réinitialiser</button>
        </div>
        <p class="muted">Les fichiers locaux seront uploadés sur le serveur si configuré.</p>
        <div style="margin-top:.6rem">
          <button class="btn" onclick="submitCreate()">Créer la série</button>
        </div>
      </div>
    </section>
  </main>

  <!-- simple modal for series details -->
  <div id="seriesModal" class="modal hidden"></div>

<script>
const API_ROOT = ''; // same origin; if deployed elsewhere, set full URL e.g. 'https://monserveur.com'
let token = localStorage.getItem('token') || null;
let currentUser = null;
const ADMIN_USERNAME = 'AnimeForever-admin'; // keep for UI decisions, actual enforcement done on server

function authFetch(url, opts = {}) {
  opts.headers = opts.headers || {};
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  return fetch(API_ROOT + url, opts);
}

async function loadMe() {
  if (!token) return;
  try {
    const res = await authFetch('/api/me');
    if (res.ok) {
      const json = await res.json();
      currentUser = json;
      document.getElementById('userInfo').innerText = json.username + (json.isAdmin ? ' (admin)' : '');
      document.getElementById('logoutBtn').style.display = '';
    } else {
      token = null; localStorage.removeItem('token'); currentUser=null;
    }
  } catch (e) { console.error(e); }
}

async function showSection(id) {
  document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = '';
  if (id === 'home') await renderSeries();
  if (id === 'create') {
    // prefill pseudo if logged in
    document.getElementById('createPseudo').value = currentUser ? currentUser.username : '';
  }
}

async function renderSeries() {
  const grid = document.getElementById('seriesGrid');
  grid.innerHTML = '<p class="muted">Chargement...</p>';
  const res = await fetch(API_ROOT + '/api/series');
  const data = await res.json();
  grid.innerHTML = '';
  if (!data.length) grid.innerHTML = '<p class="muted">Aucune série pour le moment.</p>';
  data.forEach(s => {
    const el = document.createElement('div'); el.className = 'card';
    el.innerHTML = `
      <img class="series-img" src="${s.image || ''}" alt="${s.name}">
      <h3>${s.name}</h3>
      <p class="muted">${s.desc || ''}</p>
      <p class="muted">Ajouté par : ${s.pseudo}</p>
      <div style="display:flex;gap:.5rem;margin-top:.5rem">
        <button class="btn" onclick='openSeries("${s.id}")'>Voir</button>
        ${ (currentUser && currentUser.username === ADMIN_USERNAME) ? `<button class="btn danger" onclick='deleteSeries("${s.id}")'>Supprimer</button>` : ''}
      </div>
    `;
    grid.appendChild(el);
  });
}

async function openSeries(id) {
  const res = await fetch('/api/series');
  const all = await res.json();
  const s = all.find(x => x.id === id);
  if (!s) return alert('Série introuvable');
  const modal = document.getElementById('seriesModal');
  let html = `<h2>${s.name}</h2><p>${s.desc || ''}</p><img src="${s.image||''}" style="max-width:200px;border-radius:6px"><hr>`;
  html += `<h3>Épisodes</h3>`;
  s.episodes.forEach(ep => {
    html += `<div class="episode"><div><strong>${ep.title}</strong> <div class="muted">par ${ep.pseudo}</div></div>
      <div style="display:flex;gap:.4rem">
        <a class="btn" href="${ep.src}" target="_blank">Regarder</a>
        ${ (currentUser && currentUser.username === ADMIN_USERNAME) ? `<button class="btn danger" onclick='deleteEpisode("${s.id}","${ep.id}")'>Supprimer</button>` : '' }
      </div>
    </div>`;
  });
  html += `<hr><h4>Ajouter un épisode</h4>
    <div>
      <input id="addEpTitle" placeholder="Titre (optionnel)"/>
      <input id="addEpSrc" placeholder="URL vidéo (laisser vide si upload fichier)"/>
      <input type="file" id="addEpFile"/>
      <div style="margin-top:.5rem"><button class="btn" onclick='addEpisodeToSeries("${s.id}")'>Ajouter</button></div>
    </div>`;
  html += `<hr><h4>Modifier image</h4><input id="newImgUrl" placeholder="Nouvelle URL image"/><button class="btn" onclick='updateSeriesImage("${s.id}")'>Modifier</button>`;
  html += `<hr><button class="btn" onclick="closeSeries()">Fermer</button>`;
  modal.innerHTML = html;
  modal.classList.remove('hidden');
}

function closeSeries() {
  const modal = document.getElementById('seriesModal');
  modal.classList.add('hidden');
  modal.innerHTML = '';
  renderSeries();
}

async function deleteSeries(id) {
  if (!confirm('Supprimer la série et tous ses épisodes ?')) return;
  const res = await authFetch('/api/series/' + id, { method: 'DELETE' });
  if (res.ok) { alert('Série supprimée'); renderSeries(); } else {
    const e = await res.json(); alert('Erreur: ' + (e.error || '')); 
  }
}
async function deleteEpisode(seriesId, epId) {
  if (!confirm('Supprimer cet épisode ?')) return;
  const res = await authFetch(`/api/series/${seriesId}/episodes/${epId}`, { method: 'DELETE' });
  if (res.ok) { alert('Épisode supprimé'); openSeries(seriesId); } else {
    const e = await res.json(); alert('Erreur: ' + (e.error || ''));
  }
}

async function addEpisodeToSeries(seriesId) {
  const title = document.getElementById('addEpTitle').value.trim();
  const src = document.getElementById('addEpSrc').value.trim();
  const file = document.getElementById('addEpFile').files[0];
  if (!src && !file) return alert('Fournis une URL ou un fichier');
  if (file) {
    const form = new FormData();
    form.append('file', file);
    form.append('title', title);
    const res = await authFetch(`/api/series/${seriesId}/episodes`, { method: 'POST', body: form });
    if (res.ok) { alert('Épisode ajouté'); openSeries(seriesId); } else { const e = await res.json(); alert(e.error || 'Erreur'); }
  } else {
    const res = await authFetch(`/api/series/${seriesId}/episodes`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, type: 'url', src })
    });
    if (res.ok) { alert('Épisode ajouté'); openSeries(seriesId); } else { const e = await res.json(); alert(e.error || 'Erreur'); }
  }
}

async function updateSeriesImage(seriesId) {
  const img = document.getElementById('newImgUrl').value.trim();
  if (!img) return alert('fournis une URL');
  const res = await authFetch(`/api/series/${seriesId}/image`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ image: img })
  });
  if (res.ok) { alert('Image modifiée'); openSeries(seriesId); renderSeries(); } else { const e = await res.json(); alert(e.error || 'Erreur'); }
}

function addEpBlock(data) {
  const list = document.getElementById('epBlocks');
  const id = 'ep_' + Math.random().toString(36).slice(2,9);
  const div = document.createElement('div');
  div.id = id;
  div.style = 'display:grid;grid-template-columns:1fr 160px 90px;gap:.4rem;margin-bottom:.4rem';
  div.innerHTML = `
    <input class="epTitle" placeholder="Titre épisode (optionnel)"/>
    <input class="epUrl" placeholder="Lien vidéo (laisser si fichier)"/>
    <input type="file" class="epFile"/>
  `;
  list.appendChild(div);
  if (data) {
    div.querySelector('.epTitle').value = data.title || '';
    if (data.type === 'url') div.querySelector('.epUrl').value = data.src || '';
  }
}
function clearEpBlocks() {
  document.getElementById('epBlocks').innerHTML = '';
  addEpBlock();
}

async function submitCreate() {
  const pseudo = document.getElementById('createPseudo').value.trim();
  const name = document.getElementById('createName').value.trim();
  const desc = document.getElementById('createDesc').value.trim();
  const image = document.getElementById('createImg').value.trim();
  if (!pseudo || !name) return alert('Pseudo et nom requis');
  const createRes = await authFetch('/api/series', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, desc, image })
  });
  if (!createRes.ok) { const e = await createRes.json(); return alert(e.error || 'Erreur création'); }
  const series = await createRes.json();
  const blocks = Array.from(document.querySelectorAll('#epBlocks > div'));
  for (const b of blocks) {
    const title = b.querySelector('.epTitle').value.trim();
    const url = b.querySelector('.epUrl').value.trim();
    const file = b.querySelector('.epFile').files[0];
    if (!url && !file) continue;
    if (file) {
      const form = new FormData();
      form.append('file', file);
      form.append('title', title);
      const res = await authFetch(`/api/series/${series.id}/episodes`, { method: 'POST', body: form });
      if (!res.ok) { const e = await res.json(); alert('Erreur upload: '+(e.error||'')); }
    } else {
      const res = await authFetch(`/api/series/${series.id}/episodes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, type: 'url', src: url })
      });
      if (!res.ok) { const e = await res.json(); alert('Erreur ajout: '+(e.error||'')); }
    }
  }
  alert('Série créée');
  document.getElementById('createName').value=''; document.getElementById('createDesc').value=''; document.getElementById('createImg').value='';
  clearEpBlocks(); renderSeries(); showSection('home');
}

document.getElementById('loginBtn').addEventListener('click', async () => {
  const u = document.getElementById('authUsername').value.trim();
  const p = document.getElementById('authPassword').value;
  if (!u||!p) return document.getElementById('authMsg').innerText = 'Remplis les champs';
  const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: u, password: p })});
  const j = await res.json();
  if (!res.ok) return document.getElementById('authMsg').innerText = j.error || 'Erreur';
  token = j.token; localStorage.setItem('token', token);
  await loadMe();
  document.getElementById('authModal').style.display='none';
  renderSeries();
});
document.getElementById('showRegister').addEventListener('click', ()=> {
  document.getElementById('authForm').style.display='none';
  document.getElementById('registerForm').style.display='';
});
document.getElementById('showLogin').addEventListener('click', ()=> {
  document.getElementById('authForm').style.display='';
  document.getElementById('registerForm').style.display='none';
});
document.getElementById('regBtn').addEventListener('click', async () => {
  const u = document.getElementById('regUsername').value.trim();
  const p = document.getElementById('regPassword').value;
  const p2 = document.getElementById('regPassword2').value;
  if (!u||!p||!p2) return document.getElementById('regMsg').innerText = 'Remplis les champs';
  if (p !== p2) return document.getElementById('regMsg').innerText = 'Mots de passe différents';
  const res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: u, password: p })});
  const j = await res.json();
  if (!res.ok) return document.getElementById('regMsg').innerText = j.error || 'Erreur';
  token = j.token; localStorage.setItem('token', token);
  await loadMe();
  document.getElementById('authModal').style.display='none';
  renderSeries();
});
document.getElementById('logoutBtn').addEventListener('click', () => {
  token = null; localStorage.removeItem('token'); currentUser = null;
  document.getElementById('userInfo').innerText=''; document.getElementById('logoutBtn').style.display='none';
  document.getElementById('authModal').style.display='block';
});

(async () => {
  if (!token) {
    document.getElementById('authModal').style.display='block';
  } else {
    await loadMe();
    document.getElementById('authModal').style.display='none';
  }
  addEpBlock();
  await renderSeries();
})();
</script>
</body>
  </html>
